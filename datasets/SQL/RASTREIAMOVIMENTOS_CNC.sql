USE [Corporerm_Homolog]
GO

/****** Object:  UserDefinedFunction [dbo].[RASTREIAMOVIMENTOS_CNC]    Script Date: 08/03/2021 10:38:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*---------------------------------------------
RASTREIA TODOS OS MOVIMENTOS ORIGEM A PARTIR DE UM MOVIMENTO QUALQUER
---------------------------------------------*/
CREATE FUNCTION [dbo].[RASTREIAMOVIMENTOS_CNC] ( @IDMOV INT )
RETURNS @TAB TABLE ( IDMOV	INT, NIVEL INT	)
AS
BEGIN
	IF @IDMOV IS NULL
	BEGIN
		RETURN
	END

	DECLARE  @ORIGEM TABLE( IDMOV_ORIGEM INT, NIVEL INT)
	DECLARE @NIVEL INT

	SET @NIVEL = 1

	INSERT INTO @ORIGEM(IDMOV_ORIGEM, NIVEL)
	VALUES(@IDMOV, @NIVEL)

	INSERT INTO @TAB ( IDMOV, NIVEL )
	SELECT IDMOV_ORIGEM, NIVEL FROM @ORIGEM

	
	WHILE (SELECT COUNT(1)  FROM @ORIGEM) > 0
	BEGIN

		IF (SELECT COUNT(1)  FROM TMOVRELAC R WHERE R.IDMOVDESTINO IN (SELECT IDMOV_ORIGEM FROM @ORIGEM WHERE NIVEL = @NIVEL)) > 0
		BEGIN
			SET @NIVEL = @NIVEL + 1

			INSERT INTO @TAB ( IDMOV,NIVEL )
			SELECT R.IDMOVORIGEM,@NIVEL  FROM TMOVRELAC R WHERE R.IDMOVDESTINO IN (SELECT IDMOV_ORIGEM FROM @ORIGEM WHERE NIVEL = (@NIVEL - 1) )					

			INSERT INTO @ORIGEM
			SELECT R.IDMOVORIGEM, @NIVEL  FROM TMOVRELAC R WHERE R.IDMOVDESTINO IN (SELECT IDMOV_ORIGEM FROM @ORIGEM WHERE NIVEL = (@NIVEL - 1) )
		END
		ELSE
		BEGIN
			DELETE FROM @ORIGEM
		END

	END

	RETURN
END
GO

